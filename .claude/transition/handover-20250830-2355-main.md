# [Handoff] "handover is running…" — 2025-08-30 23:55 (branch: main)

## Goal / Scope
- AWSCCプロバイダーから標準AWSプロバイダーへの移行完了
- KMS暗号化削除によるコスト削減の実現
- Lambda関数の環境変数化と設定外部化
- uv開発環境とVS Code設定の整備
- ドキュメント更新（README.md、CLAUDE.md）

## Key decisions
- **採用**: 標準AWSプロバイダーのみ使用（ユーザー要望によりAWSCC削除）
- **採用**: KMS暗号化削除でコスト削減（CloudWatch Logs暗号化なし）
- **採用**: Lambda設定値の環境変数化（Discord Webhook設定など）
- **採用**: ファイル参照方式でLambdaデプロイ（インラインコードから変更）
- **採用**: Cost ExplorerリージョンはUS East 1固定（AWSの仕様）
- **採用**: .vscode/settings.jsonでuv仮想環境を自動認識
- **却下**: 動的リージョン取得（Cost Explorerは常にus-east-1必須）

## Done / Pending
### 完了
- terraform/main.tf: AWSCCプロバイダー削除、KMS関連リソース削除
- terraform/main.tf: awscc_iam_role → aws_iam_role変更、ポリシー分離
- terraform/main.tf: Lambda環境変数追加（LOG_LEVEL、WEBHOOK設定など）
- terraform/main.tf: archive_fileでlambdaフォルダ参照に変更
- terraform/outputs.tf: AWSCC参照を標準AWS参照に修正
- lambda/lambda_function.py: 環境変数から設定値取得に変更
- pyproject.toml: hatch設定追加でuv sync修正
- .vscode/settings.json: Python仮想環境設定
- README.md、CLAUDE.md: 最新構成に合わせて更新

### 未完
- なし（すべて完了）

## Next actions
1. `uv sync`で依存関係確認
2. `terraform init && terraform validate`でTerraform設定確認
3. `terraform plan`で変更内容確認
4. `terraform apply`でインフラデプロイ
5. Lambda関数の手動テスト実行
6. CloudWatch Logsでログ確認
7. Discord通知の動作確認

## Affected files
- terraform/main.tf:10-18,33-35,51-97,102-107,114-115 (AWSCC削除、IAM修正、環境変数追加)
- terraform/outputs.tf:5,10,25,30 (AWSCC参照をAWS参照に修正)
- lambda/lambda_function.py:8-20,29-30 (環境変数取得に変更)
- pyproject.toml:36-37 (hatch設定追加)
- .vscode/settings.json:1-13 (新規作成)
- README.md:31,191-195,197-206 (アーキテクチャ、セキュリティ、コスト更新)
- CLAUDE.md:27-34,111-118,161-172,262-268 (開発方針、環境変数、コスト最適化更新)

## Affected symbols
- aws_iam_role.lambda_role (awscc_iam_roleから変更)
- aws_iam_role_policy_attachment.lambda_basic_execution (新規追加)
- aws_iam_role_policy.cost_explorer_access (新規追加)
- data.archive_file.lambda_zip (インラインからファイル参照に変更)
- lambda_function.lambda_handler() (環境変数取得ロジック追加)

## Repro / Commands
```bash
# 開発環境セットアップ
uv sync

# Terraform検証とデプロイ
cd terraform
terraform init
terraform validate
terraform plan
terraform apply

# ローカルテスト
cd ..
make test-local
make test
```

## Risks / Unknowns
- 既存のAWSCCリソースがある場合、terraform destroyが必要な可能性
- KMS削除後のCloudWatch Logs既存データ（検証: ログ確認）
- Lambda関数のhandler名変更による既存デプロイへの影響（検証: terraform plan確認）
- VS Code設定のPython環境認識（検証: VS Code再起動）

## Links
- GitHub Repository: aws-cost-notifier-for-discord
- 関連技術: AWS Lambda, Terraform, uv, VS Code settings