import json
import boto3
from datetime import timedelta, date
import requests
import os
import logging

# ãƒ­ã‚°è¨­å®š
logger = logging.getLogger()
logger.setLevel(logging.INFO)

# Discordã®Webhook URLã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
try:
    DISCORD_WEBHOOK_URL = os.environ['DISCORD_WEBHOOK_URL']
except KeyError:
    logger.error("ç’°å¢ƒå¤‰æ•°DISCORD_WEBHOOK_URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
    raise

# Webhookã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºè¨­å®š
WEBHOOK_AVATAR_URL = "https://icon.icepanel.io/AWS/svg/Cloud-Financial-Management/Cost-Explorer.svg"
WEBHOOK_USERNAME = "AWS Cost Notifier"


def get_cost(start_date, end_date):
    """
    æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã®AWSåˆ©ç”¨æ–™é‡‘ã‚’å–å¾—ã™ã‚‹
    """
    try:
        # Cost Explorerã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯US East 1ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¿…é ˆ
        client = boto3.client("ce", region_name="us-east-1")
        logger.info(f"{start_date}ã‹ã‚‰{end_date}ã¾ã§ã®ã‚³ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­")
        
        response = client.get_cost_and_usage(
            TimePeriod={"Start": start_date, "End": end_date},
            Granularity="DAILY",
            Metrics=["UnblendedCost"],
        )
        
        # è¤‡æ•°æ—¥é–“ã®åˆè¨ˆã‚³ã‚¹ãƒˆã‚’è¨ˆç®—
        total_cost = 0
        for result in response["ResultsByTime"]:
            amount = float(result["Total"]["UnblendedCost"]["Amount"])
            total_cost += amount
            logger.info(f"æ—¥ä»˜: {result['TimePeriod']['Start']}, ã‚³ã‚¹ãƒˆ: ${amount:.2f}")
        
        logger.info(f"åˆè¨ˆã‚³ã‚¹ãƒˆ: ${total_cost:.2f}")
        return total_cost
        
    except Exception as e:
        logger.error(f"ã‚³ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: {str(e)}")
        raise


def post_to_discord(message, cost):
    """
    Discordã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿ã™ã‚‹
    """
    try:
        headers = {
            "Content-Type": "application/json",
        }

        embed = {
            "title": "AWSæ–™é‡‘é€šçŸ¥ ğŸ’°",
            "description": message,
            "color": 0xFF9900,  # AWSã‚ªãƒ¬ãƒ³ã‚¸
            "thumbnail": {"url": WEBHOOK_AVATAR_URL},
            "fields": [
                {
                    "name": "ğŸ’¸ åˆè¨ˆé‡‘é¡",
                    "value": f"${cost:.2f} USD",
                    "inline": True,
                },
                {
                    "name": "ğŸ“… æœŸé–“",
                    "value": "éå»7æ—¥é–“",
                    "inline": True,
                }
            ],
            "footer": {
                "text": "AWS Cost Explorer | Generated by Terraform âš¡",
                "icon_url": WEBHOOK_AVATAR_URL
            },
            "timestamp": date.today().isoformat()
        }

        payload = {
            "username": WEBHOOK_USERNAME,
            "avatar_url": WEBHOOK_AVATAR_URL,
            "embeds": [embed],
        }

        logger.info("Discordé€šçŸ¥ã‚’é€ä¿¡ä¸­")
        response = requests.post(DISCORD_WEBHOOK_URL, headers=headers, data=json.dumps(payload))
        response.raise_for_status()
        logger.info(f"Discordé€šçŸ¥é€ä¿¡å®Œäº†ã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {response.status_code}")
        
    except requests.exceptions.RequestException as e:
        logger.error(f"Discordé€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼: {str(e)}")
        raise
    except Exception as e:
        logger.error(f"äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        raise


def lambda_handler(event, context):
    """
    Lambdaé–¢æ•°ã®ãƒ¡ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©
    """
    try:
        logger.info("AWS Cost Notifier Lambdaé–¢æ•°ã‚’é–‹å§‹")
        
        # å®Ÿè¡Œæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
        today = date.today()
        one_week_ago = today - timedelta(days=7)

        logger.info(f"ã‚³ã‚¹ãƒˆåˆ†ææœŸé–“: {one_week_ago} ã‹ã‚‰ {today}")

        # æ–™é‡‘å–å¾—æœŸé–“ã‚’è¨­å®šï¼ˆ1é€±é–“å‰ã‹ã‚‰å®Ÿè¡Œæ—¥ã¾ã§ï¼‰
        start_date = one_week_ago.strftime("%Y-%m-%d")
        end_date = today.strftime("%Y-%m-%d")

        # Cost Explorerã‹ã‚‰æ–™é‡‘ã‚’å–å¾—
        cost = get_cost(start_date, end_date)

        # Discordã¸ã®é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
        message = f"**{one_week_ago.strftime('%Yå¹´%mæœˆ%dæ—¥')}** ã‹ã‚‰ **{today.strftime('%Yå¹´%mæœˆ%dæ—¥')}** ã¾ã§ã®AWSåˆ©ç”¨æ–™é‡‘ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ ğŸ“Š"

        # Discordã«é€šçŸ¥
        post_to_discord(message, cost)

        logger.info("AWS Cost Notifier Lambdaé–¢æ•°ãŒæ­£å¸¸ã«å®Œäº†")
        return {
            "statusCode": 200,
            "body": json.dumps({
                "message": "Discordé€šçŸ¥é€ä¿¡å®Œäº†",
                "cost": cost,
                "period": f"{start_date} to {end_date}"
            })
        }

    except Exception as e:
        error_message = f"Lambdaé–¢æ•°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {str(e)}"
        logger.error(error_message)
        
        return {
            "statusCode": 500,
            "body": json.dumps({
                "error": error_message
            })
        }


# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç”¨
if __name__ == "__main__":
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã®ãƒ¢ãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
    test_event = {}
    test_context = type('Context', (), {
        'function_name': 'aws-cost-notifier-test',
        'function_version': '$LATEST',
        'invoked_function_arn': 'arn:aws:lambda:us-east-1:123456789012:function:aws-cost-notifier-test',
        'memory_limit_in_mb': 256,
        'remaining_time_in_millis': lambda: 30000,
        'log_group_name': '/aws/lambda/aws-cost-notifier-test',
        'log_stream_name': '2024/01/01/[$LATEST]abcdefg1234567890',
        'aws_request_id': 'test-request-id'
    })()
    
    result = lambda_handler(test_event, test_context)
    print(json.dumps(result, indent=2))
